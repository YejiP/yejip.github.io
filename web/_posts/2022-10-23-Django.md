# Django Work Flow

## Initial setup

1. Create venv, and install django within venv

   ```
   python3 -m venv venv
   source venv/bin/activate
   pip install django
   ```

2. Create Django project and app

   ```python
   django-admin startproject project_name
   cd project_name
   python manage.py startapp app_name
   ```

3. Start git

   ```
   git init
   git add .
   git commit -m 'start app'
   ```

4. Add 'appname.appnameConfig'(check it from apps.py file) in installed_app array.

   ```
   @settings.py
   INSTALLED_APPS = [
   		'appname.apps.appnameConfig',
       'django.contrib.admin',
       'django.contrib.auth',
       'django.contrib.contenttypes',
       'django.contrib.sessions',
       'django.contrib.messages',
       'django.contrib.staticfiles',
   ]
   
   ALLOWED_HOSTS = ['127.0.0.1', ]
   ```

6. Change sqlite into Postgres. -> create postgres database first and then add this setup.

   ```
   @settings.py
   DATABASES = {
       'default': {
           'ENGINE': 'django.db.backends.postgresql_psycopg2',
           'NAME': 'db_name',
           'USER': 'postgres',
           'PASSWORD': 'postgres',
           'HOST': 'localhost',
           'PORT': '5432',
       }
   ```

   

## Model Setup

```python
@models.py
#django built-in user
from django.contrib.auth.models import User

#create post model
class post(models.Model):
  title = models.CharField(max_length = 30)
```

Run this command in terminal to convert django orm into sql queries

```
python manage.py makemigrations
python manage.py migrate
```

Create superuser

```
python manage.py createsuperuser
```



## Restful API - End Point Setup

REST has 7 end points. 

```
index, detail, new, create, edit, update, delete
```

```python
@views.py
def detail(request,post_id):
  context = {'posts' : Post.objects.filter(post_id=1)} 
  return render(request,'detail.html', context )

@urls.py
from . import post_views
urlpatterns = [
    path('<int:note_id>/detail/', post_views.detail, name='detail'),
]

@template.html
{% urls 'detail' %}
```



### REST API Skeleton

@**views.py**

```python
from django.shortcuts import render

def index(request):
    pass

def detail(request, post_id):
    pass

def new(request):
    pass

def create(request):
    pass

def edit(request, post_id):
    pass

def update(request, post_id):
    pass

def delete(request, post_id):
    pass
```

@ urls.py under app directory

```python
from django.urls import path
from . import views

urlpatterns = [
    path('/', views.index, name='index'),
    path('<int:post_id>/', views.detail, name='detail'),
    path('new/', views.new, name='new'),
    path('create/', views.create, name='create'),
    path('<int:post_id>/edit/', views.edit, name='edit'),
    path('<int:post_id>/update/', views.update, name='update'),
    path('<int:post_id>/delete/', views.delete, name='delete'),
]
```

@ urls.py under project directory

```python
urlpatterns = [
    path('admin/', admin.site.urls),
    path('route/', include('appname.urls')),
]
```

## Testing with postman

Add @csrf_exempt to the function, and send raw-json data, add 'content-type' application-json to the header.

in django file, this data will be received using 'request.body' instead of 'request.post'

​    data = json.loads(request.body.decode('utf-8'))

## Template

- django convention 
- render(request,'appname/index.html') => render will automatically look into templates folder.

```
app
	|_templates
			 |_ appname
 					|_ usercreation.html
```

## Form 

@form.py

```python
from django import forms

class LoginForm(forms.Form):
	title = forms.CharField(max_length=100)
```

@views.py

```python
from .form import LoginForm

def login_new(request):
	f = LoginForm()
	return render(request,'login.html',{'form':f})
```

@login.html

```html
<form action= "{% url 'create' %}" method = "post">
    {% csrf_token %}
		{{form}}
<input type="submit" value="Submit">
</form>
```

## Django Built-in User API setup

### Creating new user

@forms.py

```python
from django import forms
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth.models import User

class CustomizedForm(UserCreationForm):
  email = forms.EmailField()
  #This will enable CustomizedForm.save() to create model specified in Meta class.
  class Meta:
    Model = User
    Fields = ["username","email","password1","password2"]
```

@views.py

```python
from .forms import CustomizedForm
from django.shortcuts import render,redirect

def register(request):
  if request.method == "POST"
  	form = CustomizedForm(request.POST)
    if form.is_valid():
      #This method will automatically create user model
      form.save()
	    return redirect('index')
	else:
  	return render(request,'register.html',{'form':CustomizedForm()})
  
```

@urls.py

```py
from django.urls import path
from . import views
urlpatterns = [
  path('register/',views.register,name="register"),
]
```

## 

## login



```python
from django.contrib.auth import views as auth_views
urlpatterns = 
[
  path('login/',auth_views.LoginView.as_view(template_name="user/login.html"), name="login"),
  path('logout/',auth_views.LogoutView.as_view(template_name="user/logout.html"), name="logout")
  
]
```

@user/login.html

form is automatically generated and conveyed to this template. 

```html
{% extends 'bookpost/base.html' %}
{% load crispy_forms_tags %}
{% block content %}
<form method="POST">
{% csrf_token %}
{{form | crispy }}
<input type="submit" value="Submit">
</form>
{% endblock content %}
```

once form i submitted, this will automatically redirect to 'accounts/profile/', to change this, we can change this defualt in the settings.py

also, django's default login route is "accounts/login" we can change this too.

```python
LOGIN_REDIRECT_URL = 'index'
LOGIN_URL = 'login'
```

user seems to be given with any situation?= > check

```html
{% if user.is_authenticated %}
```



```python
from django.contrib.auth.decorators import login_required

@login_required
def profile(request):
  render(request,'profile.html')
```

# User

how to extend user model?

```python
@models.py
from django.db improt models
from django.contrib.auth.models import User

#create one to one relationship with existing model
class profile(models.Model):
  user = models.OneToOneField(User, on_delete = models.CASCADE)
  image = models.ImageField(default ='default.jpg',upload_to = 'profile_pics')
  
  def __str__(self):
    return f'{self.user.username} Profile'
  
  def save(self):
    super().save()
    img=Image.open(self.image.path)
    
    if img.height > 300 or img.width >300:
      output_size = (300,300)
      img.thumbnail(output_size)
      img.save(self.image.path)
```

```
user.profile 
user.profile.image.url
```

run migration

to use imagefield, pip install pillow.

@admin.py

```python
from django.contrib import admin
from .models import Profile
# This will enable to add profile file from admin site offered by django
admin.site.register(Profile) 
```

@project settings

```python
#in base dir, media directory will be created and all media files will be here as a default
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
#media url is how we access to media directory
MEDIA_URL = '/media/'
```

@ urls.py

```python
from django.conf import settings
from django.conf.urls.static import static
urlpatterns = [ 
    ..
  ]

if settings.DEBUG :
 urlpatterns += static(settings.MEDIA_URL,document_root = settings.MEDIA_ROOT)
  
```

@signals.py

=> 

```python
# this is signal that gets fired after post is saved
from django.db.models.signals import post_save
from django.contrib.auth.models import User
from django.dispatch import receiver
from .models import Profile

#we want uesr pf to create for each new user
#when User is saved, then send the signal, then that signal is going to be received by this signal
@receiver(post_save, sender=User)
def create_profile(sender, instance, created, **kwargs):
  #if user is created, create profile object which has one to one relatinoship wiht this user instance
  if created:
    Profile.objects.create(user=instance)
    
@receiver(post_save, sender=User)
def save_profile(sender, instance,**kwargs):
  instance.profile.save()
```

and then,

users/apps.py

```python
class UserConfig(AppConfig):
  name = 'users'
  
  def ready(self):
    import users.signals
```



## Update User Profile

```python
from django import forms
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth.models import User
from .models import Porfile
class CustomizedForm(UserCreationForm):
  email = forms.EmailField()
  #This will enable CustomizedForm.save() to create model specified in Meta class.
  class Meta:
    Model = User
    Fields = ["username","email","password1","password2"]

class UserUpdateForm(forms.ModelForm):
  email = forms.EmailField()
  
  class Meta:
    fields = ['username','email']

class ProfileUpdateForm(forms.ModelForm):
  class Meta:
    model = Profile
    fields = ['image']
```

views.py

```python
from .forms import UserUpdateForm, ProfileUpdateForm

@login_required
def profile(request):
  if request.method =="POST":
    u_form = UserUpdateForm(request.POST,instance = request.user)
    p_form = ProfileUpdateForm(request.POST,
                               request.FILES,
                               instance = request.user.profile)
    if u_form.is_valid() and p_form.is_valid():
      u_form.save()
      p_form.save()
      messages.success(request,f"your account has been updated")
      return redirect('profile')
    
  else:
    u_form = UserUpdateForm(instance = request.user)
    p_form = ProfileUpdateForm(instance = request.user.profile)    
    
  context = {
    'u_form' : u_form,
    'p_form' : p_form
  }
  return render(request,'user/profile.html',context)
```

@

image form, we have to add enctype ="multipart/form-data"

```
{% load crispy_forms_tags %}
<form method="POST" enctype="multipart/form-data">Profile Info
{{ csrf_tocken }}
{{ u_form | crispy}}
{{ p_form | crispy}}
<button type="submit" value="Update">
</form>
```

## email, and reset the password

django offers default one, django will handle this!

```python
urlpatterns = [
  path('password-reset/', auth_views.PasswordResetView.as_view(tempate_name = 'users/password_reset.html'), name = 'password_reset'),
  path('password-reset/done/', auth_views.PasswordResetDoneView.as_view(tempate_name = 'users/password_reset_done.html'), name = 'password_reset_done'),
  path('password-reset-confirm/<uidb64>/<token>/', auth_views.PasswordResetConfirmView.as_view(tempate_name = 'users/password_reset_done.html'), name = 'password_reset_confirm'),
  path('password-reset-complete/', auth_views.PasswordResetCompleteView.as_view(tempate_name = 'users/password_reset_complete.html'), name = 'password_reset'),
]
```

password_reset.html

```
{% load crispy_forms_tags %}
<form method="POST">Reset Password
{{ csrf_tocken }}
{{ u_form | crispy}}
{{ p_form | crispy}}
<button type="submit" >Reqeust Password Reset
</form>
```

password_reset_done.html

```
An email has been sent with instructions to reset your password
```

password_reset_confirm.html
```
{% load crispy_forms_tags %}
<form method="POST">Reset Password
{{ csrf_tocken }}
{{ form | crispy}}
<button type="submit" >Reset Password
</form>
```

@setups.py

```
EMAIL_BACKEND ='django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_PORT = 587
EMAIL_USER_TLS = True
#get credentials from .env file
EMAIL_HOST_USER = os.environ.get('EMAIL_USER')
EMAIL_HOST_PASSWORD = os.environ.get('EMAIL_PASS')
```

'users/password_reset_complete.html'

```
Your password has been set.
<a href = "{% url 'login' %}" Sign In Here </a>
```



# CRUD - Class based view

```python
def home(request):
  context = {'posts' : Post.objects.all()}
  return render(request, 'blog/home.html', context)

#Class view
from django.views.generic import ListView
class PostListView(ListView):
  model = Post
  #if we don't set it, app/model_viewtype.html will be set. 
  template_name = 'blog/home.html'
  #object_list will be default for context object name.
  context_object_name = 'posts'
  ordering = ['date_posted']

@urls.py
from .views import PostListView
urlpatterns = [
  path('',PostListView.as_view(),name='blog-home'),
]
```



detail view

```python
@views.py
from django.views.generic import DetailView
class PostDetailView(DetailView):
  model=Post
 
@urls.py
from .views import PostDetailView
urlpatterns = [
  path('post/<int:pk>/',PostDetailView.as_view(),name= 'post-detail')
]
```

create blog/post_detail.html, and as context variable, {object:[]} will be passed down



```python
@views.py
from django.views.generic import CreateView
class PostCreateView(CreateView):
  model=Post
  fields = ['title','content']
  
  #Telling django that before you submit, take the form instance that's passed from user and set author and validate form.
  #so we are overriding form_valid method, so this function will run. so we can set an author and pass it to parent's class
  def form_valid(self,form):
    form.instance.author = self.request.user
    return super().form_valid(form)
 
@urls.py
from .views import PostCreateView
urlpatterns = [
  path('post/new/',PostCreateView.as_view(),name= 'post-create')
]
```

blog/post_form.html

```
{% load crispy_forms_tags %}
<form method="POST">
{{ csrf_tocken }}
{{ form | crispy}}
<button type="submit" value="Post">
</form>
```

this will read to model/model_url, and we have to articulate what is model_url

```python
@models.py
class Post(models.Model):
  title = models.CharField(max_length=100)
  content= models.TextField()
  date_posted = models.DateTimeField(default = timezone.now)
  author = models.ForeignKey(User, on_delete=models.CASCADE)
  
  def __str__(self):
    return self.title
  
 def get_absolute_url(self):
  return reverse('post-detail', kwarg={'pk':self.pk})
```

login required

```python
from django.contrib.auth.mixins import LoginRequiredMixin
class PostCreateView(LoginRequiredMixin,CreateView):
  model=Post
  fields = ['title','content']

  def form_valid(self,form):
    form.instance.author = self.request.user
    return super().form_valid(form)
 
```

update

UserPassesTestMixin, prevent post to be updated from unrelated user

```python
from django.contrib.auth.mixins import LoginRequiredMixin,UserPassesTestMixin
from django.views.generic import UpdateView
class PostUpdateView(LoginRequiredMixin,UserPassesTestMixin,UpdateView):
  model=Post
  fields = ['title','content']

  def form_valid(self,form):
    form.instance.author = self.request.user
    return super().form_valid(form)
  
  def test_func(self):
    post self.get_object()
    if self.request.user == post.author :
      return True
    return False
 
@urls.py
urlspattern = [
  path("post/<int:pk>/update/",PostUpdateView.as_view(),name='post-update')
]
```

Delete 

```python
@views.py
from django.views.generic import DeleteView
class PostDeleteView(LoginRequiredMixin,UserPassesTestMixin,DeleteView):
  model = Post
	success_url = "/"
  def test_func(self):
    post self.get_object()
    if self.request.user == post.author :
      return True
    return False
 
@urls.py
from .views import PostDeleteView
urlpatterns = [
  path('post/<int:pk>/delete',PostDeleteView.as_view(),name= 'post-delete')
]
```

post_confirm_delete.html

```
 {% load crispy_forms_tags %}<form method="POST">{{ csrf_tocken }}
 Delete Post
 <button type="submit" value="delete">delete</button>
 <a href="{% url 'post-detail' object.id %}">no</button>
 </form>
```

# Pagination

```python
from django.core.paginator import Paginator
data = Posts.objects.all()
#2 per page
p = Paginator(data,2)
p1 = p.page(1)
p1.object_list
p1.has_previous()
p1.has_next()
```



```python

#Class view
from django.views.generic import ListView
class PostListView(ListView):
  model = Post
  #if we don't set it, app/model_viewtype.html will be set. 
  template_name = 'blog/home.html'
  #object_list will be default for context object name.
  context_object_name = 'posts'
  ordering = ['date_posted']
  paginate_by = 2

```

```
{% if is_paginated %}
	{% if page_obj.has_previous %}
		<a href="?page=1">First</a>
	{% endif %}

	{% for num in page_obj.paginator.page_range %}
		{% if page_obj.number ==num %}
		<a href="?page={{num}}">num</a>
		{% elif num > page_obj.number|add:'-3' and num < page_obj.number | add '3' %}
    
		{% endif %}
	{% endfor%}
	
 	{% if page_obj.has_next %}
		<a href="?page={{page_obj.paginator.num_pages}}">last</a>
	{% endif %}

{% endif %}
```

## UserListView

```python
#Class view
from django.views.generic import ListView
from djaongo.shortcuts import get_object_or_404
from django.contrib.auth.models import User
class UserPostListView(ListView):
  model = Post
  #if we don't set it, app/model_viewtype.html will be set. 
  template_name = 'blog/home.html'
  #object_list will be default for context object name.
  context_object_name = 'posts'
  paginate_by = 5
  
  def get_queryset(self):
    user = get_object_or_404(User,username=self.kwargs.get('username'))
    return Post.objects.filter(author= user).order_by('-date_posted')
```

```python
@urls.py
urlspattern = [
  path('user/<str:username>',UserPostListView.as_view(),name = 'user-posts')
]
```

user_posts.html

```
Posts by {{view.kwargs.username }} {{page_obj.paginator.count}}
<a href = "{% url 'user-posts' post.author.username %}">{{post.author}}<a>
```



# Additional

## Message

```python
from django.contrib import messages
username = "callie"
messages.success(request,f"good! {username}")
```

## crispy form

installation

```
pip install django-crispy-forms
```

Usage

@settings.py

```python
INSTALLED_APPS = [
  ....,
  'crispy_forms',
  .....
]

CRISPY_TEMPLAT_PACK = 'bootstrap4'
```

@ html

form variable is coming from views as a parameter

```
{% load crispy_forms_tags %}
<form method="POST">
{{ csrf_tocken }}
{{ form | crispy}}
<button type="submit" value="submit">
</form>
```

